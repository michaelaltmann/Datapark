<!DOCTYPE html>
<html>
<head>
<title>DataPark</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" type="text/css" href="styles/datapark.css" />
<script type="text/javascript"
	src="lib/jquery-1.10.1.min.js"></script>

<script type="text/javascript">
	$(document).ready(function() {
		getResults();
	});

	function getResults() {
		// Should get these from the index.html
		var lon = -93.29;
		var lat = 44.92;
		var radius = 100;
		
		var spacesURL = 'http://michaelaltmann.cartodb.com/api/v2/sql';
		var vacancyURL = 'http://michaelaltmann.cartodb.com/api/v2/sql';

		$.getJSON(spacesURL, {
			q : "select sum(parking_supply.spaces) as tot from parking_supply where ST_Distance_Sphere(the_geom,ST_MakePoint("+lon+","+lat+")) < " + radius
		}, function(data) {
			var spaces = data.rows[0].tot;
			spaces = Math.round(spaces);
			$('#before_spaces').text(spaces);
			$('#option1_spaces').text(spaces);
		});
		var current_vacancy_query = "with x as (select s.the_geom, s.the_geom_webmercator, s.address, s.spaces, \n" +
		" s.spaces - COALESCE(( \n" +
		"  select s.spaces * sum( d.cars * (100 - ST_Distance_sphere(s.the_geom, d.the_geom) ) / \n" +
		"  -- total affinity for this row in parking_demand \n" +
		"  (select \n" +
		"  sum( s2.spaces * (100 - ST_Distance_sphere(s2.the_geom, d.the_geom) ) ) \n" +
		"  from parking_supply as s2 \n" +
		"  where ST_Distance_sphere(s2.the_geom, d.the_geom) < 100) \n" +
		"  ) \n" +
		"  from parking_demand as d \n" +
		"  where ST_Distance_sphere(s.the_geom, d.the_geom) < 100 \n" +
		"  and  option is null \n" +
		"  ),0) as vacancy \n" +
		" from parking_supply as s) select sum(x.vacancy) as tot from x where ST_Distance_Sphere(x.the_geom,ST_MakePoint("+lon+","+lat+")) < " + radius;

		var option1_vacancy_query = "with x as (select s.the_geom, s.the_geom_webmercator, s.address, s.spaces, \n" +
		" s.spaces - COALESCE(( \n" +
		"  select s.spaces * sum( d.cars * (100 - ST_Distance_sphere(s.the_geom, d.the_geom) ) / \n" +
		"  -- total affinity for this row in parking_demand \n" +
		"  (select \n" +
		"  sum( s2.spaces * (100 - ST_Distance_sphere(s2.the_geom, d.the_geom) ) ) \n" +
		"  from parking_supply as s2 \n" +
		"  where ST_Distance_sphere(s2.the_geom, d.the_geom) < 100) \n" +
		"  ) \n" +
		"  from parking_demand as d \n" +
		"  where ST_Distance_sphere(s.the_geom, d.the_geom) < 100 \n" +
		"  and  (option is null or option = '1') \n" +
		"  ),0) as vacancy \n" +
		" from parking_supply as s) select sum(x.vacancy) as tot from x where ST_Distance_Sphere(x.the_geom,ST_MakePoint("+lon+","+lat+")) < " + radius;

		
		$.getJSON(vacancyURL, {
			q : (current_vacancy_query)
		}, function(data) {
			var vacancy = data.rows[0].tot;
			vacancy = Math.round(vacancy);
			$('#before_vacancy').text(vacancy);
		});

		$.getJSON(vacancyURL, {
			q : (option1_vacancy_query)
		}, function(data) {
			var vacancy = data.rows[0].tot;
			vacancy = Math.round(vacancy);
			$('#option1_vacancy').text(vacancy);
		});

	}
</script>
</head>
<body>
	<div id="container">
		<header>
			<div id="logo">
				<a href="index.html"><img height="100px" src="images/Plogo.jpg"
					width="100px" /></a>
			</div>
			<div>
				<a href="index.html"><h1 id="header-name">DataPark</h1></a>
			</div>
			<div id="main_nav">
				<ul class="menu">
					<li><a href="index.html">Home</a></li>
					<li><a href="results.html">Results</a></li>
				</ul>
			</div>
		</header>
		<div id="page_content">


			<table>
			<tr><td><h3>Current</h3></td> <td><h3>Option 1</h3></td></tr>
				<tr>
					<td>
						<article id="before">
							Nearby parking spaces: <span id="before_spaces"></span> <br>Nearby vacant
							spaces: <span id="before_vacancy" > </span>
							
						</article>
					</td>
					<td><article id="after">
Nearby parking spaces: <span id="option1_spaces" > </span><br> Nearby vacant
							spaces: <span id="option1_vacancy" ></span>
						</article></td>
				</tr>
				<tr>
				<td>   <iframe src="http://cdb.io/15TDQSj" height="400px" width="400px"></iframe></td>
				<td>   <iframe src="http://cdb.io/19Wqg3j" height="400px" width="400px"></iframe></td>
				</tr>
			</table>

		</div>
		<!-- page_content -->
		<footer> </footer>
	</div>
	<!-- container -->
</body>
</html>
